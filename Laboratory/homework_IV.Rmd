---
title: "The Labyrinth of Multiple Testing: how to avoid the pitfall of false positives"
subtitle: "Permutation test"
author: "Livio Finos"
highlighter: highlight.js
job: Universit√† degli Studi di Padova
output:
  prettydoc::html_pretty:
    theme: leonids 
    highlight: github
    df_print: paged
    toc: true
    number_sections: true
fontsize: 11pt
geometry: margin = 1in
mode: selfcontained
hitheme: tomorrow
framework: io2012
widgets: []
---

```{r,echo=FALSE}
SOLUZIONI=TRUE
```


```{r,message=FALSE}
# install.packages("flip")
library(flip)
```

# Seeds data
Use the `seeds` data dowloading it from
<https://github.com/livioivil/flip/raw/master/data/seeds.rda>
omit the `NA`s:

```{r}
load(url("https://github.com/livioivil/flip/raw/master/data/seeds.rda"))
seeds=na.omit(seeds)
seeds
```

Use a permutation methods to test if there is any difference between the two groups in `grp` on the two variables `x` and `y`:

- perform the two tests for the two variable, (hint: `flip(.~grp,data=seeds`...)
- Combine the two p-values using the Fisher Combining Function to test the global hypothesis (hint: `npc(res,`...)
- Use a closed testing procedure to adjust the 2 p-values.


```{r,echo=FALSE,eval=SOLUZIONI}
res=flip(.~grp,data=seeds)
hist(res)
plot(res)
npc(res,"Fisher")
flip.adjust(res,"Fisher")
```


# Pharmacokinetic Study of Carbidopa 

Description:  
<http://webserv.jcu.edu/math//faculty/TShort/Bradstreet/part2/part2-table6.html>

As part of a pharmacokinetic study, 12 healthy male subjects were allocated randomly to a three period crossover design receiving one of three graded doses (25, 50, 100 mg) of Carbidopa q8h in each treatment period. A seven day washout period separated the treatment periods. The pharmacokinetic variables AUC, Cmax, and Tmax were calculated for each subject from plasma concentrations assayed from blood samples taken at 0, 0.5, 1, 1.5, 2, 3, 4, 5, 6, 7, and 8 hours postdosing following the second dose of carbidopa on the sixth day of each treatment period.


dataset:  
<http://webserv.jcu.edu/math//faculty/TShort/Bradstreet/part2/Bradp2t6.txt>


Analyze the dataset without taking in account the Study Periods.

Research questions:

- Is there a dose response for AUC, Cmax, or Tmax? Overall?
- Can dose proportionality be established? (try to fit a linear model for each endpoint, then discuss the results)



```{r,echo=FALSE,eval=SOLUZIONI}
#Reading and make-up of the data

dati=read.table("http://webserv.jcu.edu/math//faculty/TShort/Bradstreet/part2/Bradp2t6.txt",skip = 1,header = TRUE)

dati=cbind(dati[,1],matrix(as.matrix(dati[,-1]),nrow(dati)*3,4))
colnames(dati)=c("Sub","Dose","AUC","Cmax","Tmax")

dati=as.data.frame(dati)
str(dati)

dati[,3:5]=log(dati[,3:5])


```




```{r,echo=FALSE,eval=SOLUZIONI}
#Descriptives and plots:
summary(dati[,-1])
by(dati[,3:5],dati$Dose,summary)

plot(dati$Dose,(dati$AUC))

sapply(unique(dati$Sub),function(s){
  d=subset(dati,Sub==s)
  d=d[order(d$Dose),]
  lines(d$Dose,(d$AUC),col=s,lwd=2)})

```


```{r,echo=FALSE,eval=SOLUZIONI}
#Analysis. 
#A simple solution could be:

library(flip)
res=flip(.~Dose,data=dati,Strata=~Sub)
hist(res)
plot(res)
```



```{r,echo=FALSE,eval=SOLUZIONI}
#Analysis. 
#A simple solution could be:

library(flip)
# by end-points:
res=flip.adjust(res)

# Overall
npc(res,"Fisher")

```

```{r,echo=FALSE,eval=SOLUZIONI}
#Analysis. 
#A simple solution could be:

library(flip)
res=flip(.~Dose,data=dati,Strata=~Sub)
hist(res)
plot(res)
```
